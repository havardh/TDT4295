% Include this in a chapter about the FPGA and its architecture

\section{ISA}

It was decided to use a processor architecture with 16-bit instruction words and 32 general purpose registers.
The instructions are divided in three different classes, load/store instructions, arithmetic instructions
and miscellaneous instructions. All instructions have a common group field in the two most significant bits,
which is used to select between one of four instruction groups, as shown in table \ref{tab:group_fmt}.

It was decided to use four condition flags, listed in table \ref{tab:condition_flags}. These are stored in
a dedicated status and control register.

\begin{table}[ht]
	\centering
	\begin{tabular}{|l l|}
		\hline
		\textbf{Group field} & \textbf{Meaning of field} \\
		\hline
		\texttt{0b00} & Load/store instructions \\
		\hline
		\texttt{0b01} & \multirow{2}{*}{Arithmetic instructions} \\
		\texttt{0b10} & \\
		\hline
		\texttt{0b11} & Miscellaneous instructions \\
		\hline
	\end{tabular}

	\label{tab:group_fmt}
	\caption{Format of the group field}
\end{table}

\begin{table}[ht]
	\centering
	\begin{tabular}{|l l|}
		\hline
		Z & Zero flag \\
		N & Negative flag \\
		C & Carry flag \\
		V & Overflow flag \\
		\hline
	\end{tabular}
	\label{tab:condition_flags}
	\caption{Condition flags}
\end{table}

\subsection{Load/store instructions}
The format of load/store instructions is illustrated in figure \ref{fig:ls_instr_format}. The possible
instructions are listed in table \ref{tab:ls_instrs}.

\begin{figure}[ht]
	\centering
	\begin{bytefield}[endianness=little,bitwidth=0.05\linewidth]{16}
		\bitheader{0-15} \\
		\bitbox{2}{Group} &
		\bitbox{2}{Funct} &
		\bitbox{12}{Immediate}
	\end{bytefield}

	\label{fig:ls_instr_format}
	\caption{Format of load/store instructions}
\end{figure}

\begin{table}[ht]
	\centering
	\begin{tabular}{|l l l|}
		\hline
		\textbf{Funct} & \textbf{Mnemonic} & \textbf{Instruction} \\
		\texttt{0b00} & \textsc{ldm} & Load immediate \\
		\texttt{0b10} & \textsc{ldi} & Load from input buffer \\
		\texttt{0b10} & \textsc{ldo} & Load from output buffer \\
		\texttt{0b11} & \textsc{sto} & Store to output buffer \\
		\hline
	\end{tabular}

	\label{tab:ls_instrs}
	\caption{Load/store instructions}
\end{table}

\subsection{Arithmetic instructions}
The format of the arithmetic instructions is illustrated in figure \ref{fig:arith_instr_format}. The implemented
instructions are listed in table \ref{tab:arith_instrs}. In order to support other variants of the same instructions,
such as add-with-carry or multiply-and-accumulate, an option field has been added. The operations are implemented such
that the result of an operation is written back to the first operand register, $ra = ra~op~rb$.

\begin{figure}[ht]
	\centering
	\begin{bytefield}[endianness=little,bitwidth=0.05\linewidth]{16}
		\bitheader{0-15} \\
		\bitbox{2}{Group} &
		\bitbox{2}{Funct} &
		\bitbox{2}{Option} &
		\bitbox{5}{Reg A} &
		\bitbox{5}{Reg B} 
	\end{bytefield}

	\label{fig:arith_instr_format}
	\caption{Arithmetic instructions}
\end{figure}

\begin{table}[ht]
	\centering
	\begin{tabular}{|l l l l|}
		\hline
		\textbf{Group} & \textbf{Funct} & \textbf{Mnemonic} & \textbf{Instruction} \\
		\hline
		\multirow{4}{*}{\textsc{0b01}} & \texttt{0b00} & \textsc{add} & Add\\
		                               & \texttt{0b01} & \textsc{sub/cmp} & Subtract/compare\\
				               & \texttt{0b10} & \textsc{mul} & Multiply\\
				               & \texttt{0b11} & \textsc{mov} & Move between registers\\
		\hline
		\multirow{4}{*}{\textsc{0b10}} & \texttt{0b00} & \textsc{and} & Bitwise and\\
		                               & \texttt{0b01} & \textsc{or} & Bitwise or\\
				               & \texttt{0b10} & \textsc{xor} & Bitwise exclusive or\\
				               & \texttt{0b11} & \textsc{not} & Bitwise invert\\
		\hline
	\end{tabular}

	\label{tab:arith_instrs}
	\caption{Implemented arithmetic instructions}
\end{table}

\subsection{Miscellaneous instructions}
The format of the miscellaneous instructions is illustrated in figure \ref{fig:misc_instr_format}. The
implemented instructions are listed in table \ref{tab:misc_instrs}.

\begin{figure}[ht]
	\centering
	\begin{bytefield}[endianness=big,bitwidth=0.05\linewidth]{16}
		\bitheader{0-15} \\
		\bitbox{2}{Group} &
		\bitbox{1}{F} &
		\bitbox{4}{Param} &
		\bitbox{9}{Immediate}
	\end{bytefield}

	\label{fig:misc_instr_format}
	\caption{Format of the miscellaneous instructions}
\end{figure}

\begin{table}[ht]
	\centering
	\begin{tabular}{|l l l|}
		\hline
		\textbf{F field} & \textbf{Mnemonic} & \textbf{Instruction} \\
		\texttt{0} & \textsc{bcc} & Branch (with condition code) \\
		\texttt{1} & \textsc{shl/shr} & Shift left/Shift right\\
		\hline
	\end{tabular}

	\label{tab:misc_instrs}
	\caption{Implemented miscellaneous instructions}
\end{table}

